rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isCoupleMember(coupleId) {
      let coupleDoc = get(/databases/$(database)/documents/couples/$(coupleId));
      return coupleId == 'couple-' + request.auth.uid ||
             coupleId.matches('^' + request.auth.uid + '_.*') ||
             coupleId.matches('.*_' + request.auth.uid + '$') ||
             (coupleDoc.data.keys().hasAny(['members']) && coupleDoc.data.members.hasAny([request.auth.uid]));
    }

    function isSelf(userId) {
      return request.auth.uid == userId;
    }

    function isLinking(targetUserId) {
      let dataSent = request.resource.data;
      let partnerDataInDB = get(/databases/$(database)/documents/users/$(targetUserId)).data;
      return dataSent.partnerId == request.auth.uid &&
             dataSent.coupleCode == partnerDataInDB.coupleCode;
    }

    function isUnlinking(exPartnerId) {
      return resource.data.partnerId == request.auth.uid &&
             request.resource.data.partnerId == null;
    }

    // ============================================
    // REGLAS PARA 'users' - TEMPORALMENTE PERMISIVAS PARA DEBUG
    // ============================================
    match /users/{userId} {
      allow read, write: if isAuthenticated();
    }

    // Subcolecciones de users (como gamification)
    match /users/{userId}/{subcollection}/{docId} {
      allow read, write: if isAuthenticated() && isSelf(userId);
    }

    // Regla espec√≠fica para gamification
    match /users/{userId}/gamification/{docId} {
      allow read, write: if isAuthenticated() && isSelf(userId);
    }

    // ============================================
    // REGLAS PARA 'couples'
    // ============================================
    match /couples/{coupleId} {
      allow read, create, update: if isAuthenticated() && isCoupleMember(coupleId);
    }

    match /couples/{coupleId}/{subcollection}/{docId} {
      allow read, write: if isAuthenticated() && isCoupleMember(coupleId);
    }

    match /couples/{coupleId}/{subcollection}/{docId}/{nestedCollection}/{nestedDocId} {
      allow read, write: if isAuthenticated() && isCoupleMember(coupleId);
    }

    // ============================================
    // REGLAS PARA 'tests' - TEMPORALMENTE PERMISIVAS PARA DEBUG
    // ============================================
    match /tests/{testId} {
      // Temporalmente permisivo para debug
      allow read, write: if isAuthenticated();
    }
  }
}